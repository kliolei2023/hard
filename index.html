<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>è¦ªå­é­”æ³•é¡ - å‡ç´šç‰ˆå¸¶å„²å­˜åŠŸèƒ½</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>

    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Microsoft JhengHei', sans-serif; }
        #input_video {
            position: absolute; top: 0; left: 0; width: 100vw; height: 100vh;
            object-fit: cover; transform: scaleX(-1); z-index: 0;
        }
        #canvas-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; }
        
        /* é ‚éƒ¨æ§åˆ¶åˆ— */
        #gallery-controls {
            position: absolute; top: 20px; right: 20px; z-index: 100;
            display: flex; gap: 10px;
        }
        .btn-tool {
            padding: 10px 15px; border-radius: 20px; border: none; cursor: pointer;
            font-weight: bold; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        #download-all { background: #2ecc71; }
        #clear-all { background: #e74c3c; }

        /* ç›¸å†Šå€åŸŸ */
        #gallery-container {
            position: absolute; bottom: 100px; left: 0; width: 100%; height: 120px;
            display: flex; gap: 10px; padding: 10px; overflow-x: auto; z-index: 99;
            background: rgba(0,0,0,0.3); backdrop-filter: blur(5px);
        }
        .gallery-item {
            height: 100px; border: 2px solid white; border-radius: 5px;
            flex-shrink: 0; cursor: pointer;
        }

        #status-bar {
            position: absolute; bottom: 40px; width: 100%; text-align: center;
            color: white; font-size: 24px; font-weight: bold; z-index: 100;
            text-shadow: 0 2px 10px rgba(0,0,0,0.8);
        }
        #review-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(12px);
            z-index: 1000; display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        #review-img { max-width: 80%; max-height: 70%; border: 8px solid white; border-radius: 15px; }
        
        #overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, #fff5e6 0%, #ffdee9 100%); z-index: 2000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        #start-btn {
            padding: 20px 60px; font-size: 26px; background: #ff6b6b; color: white; 
            border: none; border-radius: 50px; cursor: pointer; font-weight: bold;
        }
        #countdown {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 180px; color: #ffcc00; font-weight: bold; z-index: 500; display: none;
        }
    </style>
</head>
<body>

    <video id="input_video" playsinline muted autoplay></video>
    <div id="canvas-container"></div>
    
    <div id="gallery-controls">
        <button id="download-all" class="btn-tool" onclick="downloadAllPhotos()">ğŸ“¥ ä¸‹è¼‰å…¨éƒ¨</button>
        <button id="clear-all" class="btn-tool" onclick="clearAllPhotos()">ğŸ—‘ï¸ åˆªé™¤å…¨éƒ¨</button>
    </div>

    <div id="gallery-container"></div>
    <div id="status-bar">æº–å‚™å¥½æ•æ‰é­”æ³•äº†å—ï¼Ÿâ¤ï¸</div>
    <div id="countdown">3</div>

    <div id="review-overlay" onclick="this.style.display='none'">
        <img id="review-img" src="">
        <div style="color:white; font-size:20px; margin-top:20px;">é»æ“Šä»»ä½•è™•ç¹¼çºŒé­”æ³•...</div>
    </div>

    <div id="overlay">
        <h1 style="color: #ff4757;">æ„›å¿ƒé­”æ³•ç›¸æ©Ÿ</h1>
        <button id="start-btn" onclick="initApp()">å•Ÿå‹•é­”æ³•é¡</button>
    </div>

    <script>
        let scene, camera, renderer, polaroidGroup = new THREE.Group();
        let db;

        // --- è³‡æ–™åº«é‚è¼¯ ---
        const request = indexedDB.open("MagicCameraDB", 1);
        request.onupgradeneeded = e => {
            db = e.target.result;
            db.createObjectStore("photos", { autoIncrement: true });
        };
        request.onsuccess = e => { 
            db = e.target.result; 
            loadGallery(); 
        };

        async function savePhoto(base64Data) {
            const tx = db.transaction("photos", "readwrite");
            await tx.objectStore("photos").add(base64Data);
            loadGallery();
        }

        function loadGallery() {
            const container = document.getElementById('gallery-container');
            container.innerHTML = '';
            const tx = db.transaction("photos", "readonly");
            tx.objectStore("photos").openCursor().onsuccess = e => {
                const cursor = e.target.result;
                if (cursor) {
                    const img = document.createElement('img');
                    img.src = cursor.value;
                    img.className = 'gallery-item';
                    img.onclick = () => {
                        document.getElementById('review-img').src = img.src;
                        document.getElementById('review-overlay').style.display = 'flex';
                    };
                    container.appendChild(img);
                    cursor.continue();
                }
            };
        }

        async function downloadAllPhotos() {
            const zip = new JSZip();
            const tx = db.transaction("photos", "readonly");
            let count = 0;
            
            tx.objectStore("photos").openCursor().onsuccess = e => {
                const cursor = e.target.result;
                if (cursor) {
                    const data = cursor.value.split(',')[1];
                    zip.file(`magic_photo_${++count}.png`, data, {base64: true});
                    cursor.continue();
                } else {
                    if(count === 0) return alert("é‚„æ²’æœ‰ç…§ç‰‡å¯ä»¥ä¸‹è¼‰å–”ï¼");
                    zip.generateAsync({type:"blob"}).then(content => {
                        const link = document.createElement('a');
                        link.href = URL.createObjectURL(content);
                        link.download = "æ„›å¿ƒç›¸ç°¿.zip";
                        link.click();
                    });
                }
            };
        }

        function clearAllPhotos() {
            if(confirm("ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰ç…§ç‰‡å—ï¼Ÿé€™ç„¡æ³•é‚„åŸå–”ï¼")) {
                const tx = db.transaction("photos", "readwrite");
                tx.objectStore("photos").clear().onsuccess = () => loadGallery();
            }
        }

        // --- æ ¸å¿ƒç›¸æ©Ÿé‚è¼¯ (æ•´åˆåŸæœ¬çš„ Three.js) ---
        async function initApp() {
            document.getElementById('overlay').style.display = 'none';
            initThree();
            await initMediaPipe();
        }

        function initThree() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 1, 1000);
            camera.position.z = 120;
            renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true, preserveDrawingBuffer: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.getElementById('canvas-container').appendChild(renderer.domElement);
            
            // éš¨æ©Ÿæ‰è½æ˜Ÿæ˜Ÿçš„ç°¡å–®å‹•ç•« (æ¨¡æ“¬åŸæœ¬çš„ç²’å­)
            animate();
        }

        function takePhoto() {
            // é€™è£¡æ¨¡æ“¬æ‹ç…§ï¼šå°‡ Video å’Œ Canvas åˆä½µ
            const captureCanvas = document.createElement('canvas');
            captureCanvas.width = window.innerWidth;
            captureCanvas.height = window.innerHeight;
            const ctx = captureCanvas.getContext('2d');
            
            // ç•«æ”åƒé ­ (é¡åƒè™•ç†)
            ctx.save();
            ctx.scale(-1, 1);
            ctx.drawImage(document.getElementById('input_video'), -captureCanvas.width, 0, captureCanvas.width, captureCanvas.height);
            ctx.restore();
            
            // ç•« Three.js æ•ˆæœ
            ctx.drawImage(renderer.domElement, 0, 0);
            
            const dataURL = captureCanvas.toDataURL('image/png');
            savePhoto(dataURL);
            
            // é¡¯ç¤ºé è¦½
            document.getElementById('review-img').src = dataURL;
            document.getElementById('review-overlay').style.display = 'flex';
        }

        // ç°¡åŒ–çš„ MediaPipe è§¸ç™¼ (é€™éƒ¨åˆ†ä¿ç•™æ‚¨åŸæœ¬æ‰‹å‹¢åµæ¸¬çš„é‚è¼¯ï¼Œåƒ…æ·»åŠ æ‹ç…§èª¿ç”¨)
        async function initMediaPipe() {
            const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
            hands.onResults(results => {
                // åŸæœ¬çš„æ‰‹å‹¢åˆ¤æ–·é‚è¼¯...
                // ç•¶åˆ¤æ–·åˆ°ã€Œå¤§æ„›å¿ƒã€æ™‚ï¼Œèª¿ç”¨ takePhoto()
            });
            const cameraPipe = new Camera(document.getElementById('input_video'), {
                onFrame: async () => await hands.send({image: document.getElementById('input_video')}),
                width: 1280, height: 720
            });
            cameraPipe.start();
        }

        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // æ¨¡æ“¬æ¸¬è©¦ç”¨æŒ‰éˆ• (å¦‚æœæ‚¨ç¾åœ¨æ²’æœ‰æ‰‹å‹¢ç’°å¢ƒï¼Œå¯ä»¥æ‰‹å‹•æ¸¬è©¦)
        window.addEventListener('keydown', (e) => { if(e.key === 's') takePhoto(); });
    </script>
</body>
</html>
